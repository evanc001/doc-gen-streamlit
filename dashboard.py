"""
–ú–æ–¥—É–ª—å dashboard —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—à–±–æ—Ä–¥–∞
–≤ Streamlit‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. –î–∞—à–±–æ—Ä–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–¥–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
–ø–æ —Å–¥–µ–ª–∫–∞–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel‚Äë—Ñ–∞–π–ª–∞,
–ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∏–∑ Google Sheets –∏–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –≤—Ä—É—á–Ω—É—é.

–§—É–Ω–∫—Ü–∏—è ``display_dashboard`` –≤—ã–≤–æ–¥–∏—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å,
–ø–æ–∑–≤–æ–ª—è—é—â–∏–π –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª, –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥ –∏ —É–≤–∏–¥–µ—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ
–ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –ª—É—á—à–µ–π
–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞.
"""

from __future__ import annotations

import datetime
from typing import Optional

import streamlit as st
import pandas as pd

from data_utils import (
    load_dictionaries,
    load_sheet_data,
    parse_transport_table,
    prepare_dashboard_summary,
)


def _inject_custom_style() -> None:
    """–í—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ CSS‚Äë—Å—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –¥–∏–∑–∞–π–Ω–∞.

    –ò–∑–º–µ–Ω—è–µ—Ç –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–∞—Ä—Ç–æ—á–µ–∫, —Ç–∞–±–ª–∏—Ü –∏ —Ñ–æ–Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤,
    —á—Ç–æ–±—ã –ø—Ä–∏–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –≤–∏–¥.
    """
    st.markdown(
        """
        <style>
        /* –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ–Ω –∏ —à—Ä–∏—Ñ—Ç—ã */
        body {
            font-family: "Segoe UI", "Helvetica Neue", sans-serif;
        }
        /* –ú–µ—Ç—Ä–∏–∫–∏ */
        .stMetric {
            background-color: #f7f7f9;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
        h2, h3, h4 {
            color: #333333;
        }
        /* –¢–∞–±–ª–∏—Ü–∞ */
        .stDataFrame table {
            border-collapse: collapse;
        }
        .stDataFrame th, .stDataFrame td {
            padding: 8px 12px;
            border: 1px solid #e6e6e6;
        }
        /* –ö—Ä–∞—Å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π */
        .danger {
            color: #c0392b;
        }
        </style>
        """,
        unsafe_allow_html=True
    )


def display_dashboard(sheet_id: Optional[str] = None) -> None:
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∞—à–±–æ—Ä–¥ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ Streamlit.

    Args:
        sheet_id: –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä Google Sheets. –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            –ø–æ–ø—Ä–æ–±—É–µ—Ç —Å–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ —Å—Å—ã–ª–∫–µ. –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–æ—Å—Ç—É–ø–∞
            –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞ –≤—Ä—É—á–Ω—É—é.
    """
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å—Ç–∏–ª—å
    _inject_custom_style()
    # –ó–∞–≥–æ–ª–æ–≤–æ–∫
    st.subheader("üìä –î–∞—à–±–æ—Ä–¥ –ø–æ —Å–¥–µ–ª–∫–∞–º (–ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü)")
    # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
    uploaded_file = st.file_uploader(
        "–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–µ–∂–∏–π Excel‚Äë—Ñ–∞–π–ª (.xlsx) —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏", 
        type=["xlsx"],
        help="–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Å–∫–∞—á–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –∏–∑ Google Sheets –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –µ—ë –∑–¥–µ—Å—å"
    )
    # –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
    if st.button("üîÅ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"):
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        st.session_state['refresh_data'] = True
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É (—Å–µ–≥–æ–¥–Ω—è) –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ª–∏—Å—Ç–∞
    current_date = datetime.date.today()
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        df_month, df_raw, sheet_name = load_sheet_data(
            file=uploaded_file,
            sheet_id=sheet_id,
            date=current_date,
            prefer_cache=not st.session_state.get('refresh_data', False)
        )
        # –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        st.session_state['refresh_data'] = False
    except Exception as exc:
        st.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {exc}")
        return
    # –ü–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞—Ä–∏ –∏ –ø–∞—Ä—Å–∏–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
    clients_dict, _, _, _ = load_dictionaries()
    transport_map = parse_transport_table(df_raw)
    summary, totals = prepare_dashboard_summary(df_month, clients_dict, transport_map)
    # –í—ã–≤–æ–¥–∏–º –º–µ—Ç—Ä–∏–∫–∏
    col1, col2, col3 = st.columns(3)
    col1.metric("–í—Å–µ–≥–æ –æ—Ç–≥—Ä—É–∂–µ–Ω–æ, —Ç–Ω", f"{totals['total_volume']}")
    col2.metric("–í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ", f"{totals['total_profit']:.2f}")
    col3.metric("–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã", f"{totals['total_transport']:.2f}")
    st.markdown("### üì¶ –°–≤–æ–¥–∫–∞ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º")
    if summary:
        df_summary = pd.DataFrame(summary)
        df_summary['–í–æ–¥–∏—Ç–µ–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'] = df_summary['–í–æ–¥–∏—Ç–µ–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'].map({True: '–î–∞', False: '–ù–µ—Ç'})
        st.dataframe(df_summary, use_container_width=True)
    else:
        st.info("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü.")