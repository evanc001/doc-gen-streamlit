"""
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º –∫–æ–º–ø–∞–Ω–∏–π, –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö –∑–∞ –¢–∏–º—É—Ä–æ–º.

–§—É–Ω–∫—Ü–∏–∏ –≤ —ç—Ç–æ–º –º–æ–¥—É–ª–µ –ø–æ–∑–≤–æ–ª—è—é—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞,
–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑
Streamlit, –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤ JSON. –°–ø–∏—Å–æ–∫ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤
—Ñ–∞–π–ª–µ ``timur_clients.json`` –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
"""

import json
import streamlit as st
from pathlib import Path
from typing import List, Optional, Set
from emoji_icons import get_icon_html

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É, –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π
# –ø—É—Ç—å, —á—Ç–æ–±—ã —Ñ–∞–π–ª –ª–µ–∂–∞–ª —Ä—è–¥–æ–º —Å –∑–∞–ø—É—Å–∫–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
CLIENTS_FILE = Path("timur_clients.json")

# –°–∏–Ω–æ–Ω–∏–º—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
SYNONYMS = {
    '–º7': '–º7 —Å–æ—Ñ—Ç',
    'm7': '–º7 —Å–æ—Ñ—Ç',
    'm7 soft': '–º7 —Å–æ—Ñ—Ç',
    '–º7 soft': '–º7 —Å–æ—Ñ—Ç',
    '—Ç—Ä–∏—Ç–æ–Ω': '—Ç—Ä–∏—Ç–æ–Ω —Ç—Ä–µ–π–¥',
    'triton': '—Ç—Ä–∏—Ç–æ–Ω —Ç—Ä–µ–π–¥',
    '—Ç—Ä–∏—Ç–æ–Ω —Ç—Ä–µ–π–¥': '—Ç—Ä–∏—Ç–æ–Ω —Ç—Ä–µ–π–¥',
    '—Ç—Ä–∏—Ç–∏–æ–Ω': '—Ç—Ä–∏—Ç–æ–Ω —Ç—Ä–µ–π–¥',
    '—Ç—Ä–∞–Ω–∑–∏—Ç—Å–∏—Ç–∏': '—Ç–∫ —Ç—Ä–∞–Ω–∑–∏—Ç —Å–∏—Ç–∏',
    '—Ç—Ä–∫ —Ç—Ä–∞–Ω–∑–∏—Ç —Å–∏—Ç–∏': '—Ç–∫ —Ç—Ä–∞–Ω–∑–∏—Ç —Å–∏—Ç–∏',
    '—Ç—Ä–∞–Ω–∑–∏—Ç —Å–∏—Ç–∏': '—Ç–∫ —Ç—Ä–∞–Ω–∑–∏—Ç —Å–∏—Ç–∏',
}


def load_clients() -> List[str]:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –∏–∑ —Ñ–∞–π–ª–∞ JSON.

    Returns:
        List[str]: —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –∫–æ–º–ø–∞–Ω–∏–π –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ.
    """
    if CLIENTS_FILE.exists():
        try:
            with open(CLIENTS_FILE, "r", encoding="utf-8") as f:
                data = json.load(f)
            if isinstance(data, list):
                return [c.lower().strip() for c in data if c.strip()]
        except Exception:
            pass
    return []


def save_clients(clients: List[str]) -> None:
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –≤ JSON‚Äë—Ñ–∞–π–ª.

    Args:
        clients: —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ.
    """
    try:
        # –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
        unique_clients = sorted(list(set(c.lower().strip() for c in clients if c.strip())))
        with open(CLIENTS_FILE, "w", encoding="utf-8") as f:
            json.dump(unique_clients, f, ensure_ascii=False, indent=2)
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π: {e}")


def normalize_company_name(name: str) -> str:
    """–ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ —Å —É—á–µ—Ç–æ–º —Å–∏–Ω–æ–Ω–∏–º–æ–≤.
    
    Args:
        name: –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
        
    Returns:
        str: –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
    """
    name_lower = name.lower().strip()
    return SYNONYMS.get(name_lower, name_lower)


def edit_clients(available_companies: Optional[List[str]] = None) -> List[str]:
    """–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å Streamlit –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤.
    
    –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–æ–±–∞–≤–ª—è—Ç—å –∏ —É–¥–∞–ª—è—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–π,
    –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö –∑–∞ –¢–∏–º—É—Ä–æ–º. –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π,
    –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–¥–æ–±–Ω—ã–π multiselect –¥–ª—è –≤—ã–±–æ—Ä–∞. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
    –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

    Args:
        available_companies: —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã.
            –ï—Å–ª–∏ None, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫.
    
    Returns:
        List[str]: —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –∫–æ–º–ø–∞–Ω–∏–π –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ.
    """
    st.markdown(f"### {get_icon_html('üßæ', 24)} –°–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –¢–∏–º—É—Ä–∞", unsafe_allow_html=True)
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
    saved_clients = load_clients()
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö –¥–ª—è –≤—ã–±–æ—Ä–∞
    if available_companies:
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
        available_normalized = [normalize_company_name(c) for c in available_companies]
        available_unique = sorted(list(set(available_normalized)))
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
        saved_normalized = [normalize_company_name(c) for c in saved_clients]
        
        # –í—ã–±–∏—Ä–∞–µ–º –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ –¢–∏–º—É—Ä–∞
        default_selected = [c for c in available_unique if c in saved_normalized]
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º session_state –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∏–ª–∏ –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π –∏–∑–º–µ–Ω–∏–ª—Å—è
        state_key = 'timur_clients_selected'
        if state_key not in st.session_state:
            st.session_state[state_key] = default_selected
        else:
            # –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ
            current_saved = set(saved_normalized)
            current_state = set(st.session_state[state_key])
            # –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–∏–ª—Å—è, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if current_saved != current_state:
                # –ë–µ—Ä–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
                st.session_state[state_key] = [c for c in available_unique if c in current_saved]
        
        # –ú—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–π
        selected = st.multiselect(
            "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:",
            options=available_unique,
            default=st.session_state[state_key],
            help="–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏–∏, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –æ—Ç–≤–µ—á–∞–µ—Ç–µ. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
        )
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞
        current_selected_set = set(st.session_state[state_key])
        new_selected_set = set(selected)
        if current_selected_set != new_selected_set:
            save_clients(selected)
            st.session_state[state_key] = selected
            st.success("‚úÖ –°–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –æ–±–Ω–æ–≤–ª—ë–Ω!")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫
        if selected:
            st.markdown("**–¢–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫:**")
            for company in selected:
                st.markdown(f"‚Ä¢ {company}")
        else:
            st.info("–°–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –ø—É—Å—Ç. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ.")
        
        return selected
    else:
        # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –µ—â–µ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
        if saved_clients:
            st.markdown("**–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫:**")
            for company in saved_clients:
                st.markdown(f"‚Ä¢ {company}")
            st.info("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –∏–º–∏.")
        else:
            st.info("–°–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π –ø—É—Å—Ç. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏.")
        
        return saved_clients